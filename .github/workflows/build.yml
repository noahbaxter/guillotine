name: Build Guillotine

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Configure CMake
        run: cmake -B build -G "Visual Studio 17 2022" -A x64

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Verify VST3 bundle
        shell: pwsh
        run: |
          $vst3Path = "build/Guillotine_artefacts/Release/VST3/Guillotine.vst3"
          if (-not (Test-Path $vst3Path)) {
            Write-Error "VST3 bundle not found at $vst3Path"
            Get-ChildItem -Recurse build -Filter "*.vst3" | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }
          Write-Host "[OK] VST3 bundle exists at $vst3Path"

          $binary = Get-ChildItem -Path $vst3Path -Recurse -Include "*.vst3" -File | Select-Object -First 1
          if ($binary) {
            $sizeMB = [math]::Round($binary.Length / 1MB, 2)
            Write-Host "Binary size: $sizeMB MB"
            if ($binary.Length -lt 1MB) {
              Write-Error "Binary too small - resources likely missing"
              exit 1
            }
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Guillotine-VST3-Windows-x64
          path: build/Guillotine_artefacts/Release/VST3/Guillotine.vst3
          retention-days: 30

  build-macos:
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Use latest Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Configure CMake
        run: |
          cmake -B build -G Xcode \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Verify builds
        run: |
          echo "=== Verifying VST3 bundle ==="
          VST3_PATH="build/Guillotine_artefacts/Release/VST3/Guillotine.vst3"
          if [ ! -d "$VST3_PATH" ]; then
            echo "[ERROR] VST3 not found at $VST3_PATH"
            find build -name "*.vst3" -type d
            exit 1
          fi
          echo "[OK] VST3 bundle exists"

          BINARY="$VST3_PATH/Contents/MacOS/Guillotine"
          if [ -f "$BINARY" ]; then
            lipo -info "$BINARY"
            SIZE=$(stat -f%z "$BINARY")
            SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
            echo "Size: ${SIZE_MB} MB"
          fi

          echo "=== Verifying AU bundle ==="
          AU_PATH="build/Guillotine_artefacts/Release/AU/Guillotine.component"
          if [ ! -d "$AU_PATH" ]; then
            echo "[ERROR] AU not found at $AU_PATH"
            exit 1
          fi
          echo "[OK] AU bundle exists"
          lipo -info "$AU_PATH/Contents/MacOS/Guillotine"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Guillotine-macOS
          path: |
            build/Guillotine_artefacts/Release/VST3/Guillotine.vst3
            build/Guillotine_artefacts/Release/AU/Guillotine.component
          retention-days: 30

  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            libasound2-dev \
            libcurl4-openssl-dev \
            libfreetype6-dev \
            libgl1-mesa-dev \
            libjack-jackd2-dev \
            libwebkit2gtk-4.0-dev \
            libx11-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxss-dev \
            pkg-config

      - name: Configure CMake
        run: cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Verify Linux VST3 bundle
        run: |
          echo "=== Checking VST3 bundle structure ==="
          VST3_PATH="build/Guillotine_artefacts/Release/VST3/Guillotine.vst3"
          if [ ! -d "$VST3_PATH" ]; then
            echo "[ERROR] VST3 bundle not found at $VST3_PATH"
            find build -name "*.vst3" -type d
            exit 1
          fi
          echo "[OK] VST3 bundle directory exists"
          find "$VST3_PATH" -type f

          SO_FILE="$VST3_PATH/Contents/x86_64-linux/Guillotine.so"
          if [ ! -f "$SO_FILE" ]; then
            echo "[ERROR] VST3 .so file not found"
            exit 1
          fi
          echo "[OK] VST3 .so file found"
          ls -la "$SO_FILE"

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Guillotine-VST3-Linux-x64
          path: build/Guillotine_artefacts/Release/VST3/Guillotine.vst3
          retention-days: 30

  test-macos:
    needs: [build-macos]
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: Guillotine-macOS
          path: ./plugin/

      - name: Install plugin to expected location
        run: |
          mkdir -p ~/Library/Audio/Plug-Ins/VST3
          cp -R ./plugin/VST3/Guillotine.vst3 ~/Library/Audio/Plug-Ins/VST3/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Download pluginval
        run: |
          curl -L -o pluginval.zip https://github.com/Tracktion/pluginval/releases/latest/download/pluginval_macOS.zip
          unzip pluginval.zip -d /usr/local/bin
          chmod +x /usr/local/bin/pluginval.app/Contents/MacOS/pluginval
          ln -s /usr/local/bin/pluginval.app/Contents/MacOS/pluginval /usr/local/bin/pluginval

      - name: Build C++ unit tests
        run: |
          cd tests/unit
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      - name: Run all tests
        run: pytest tests/ -v

  test-windows:
    needs: [build-windows]
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: Guillotine-VST3-Windows-x64
          path: ./plugin/

      - name: Install plugin to expected location
        shell: pwsh
        run: |
          $destDir = "C:\Program Files\Common Files\VST3"
          Write-Host "=== Downloaded artifact structure ==="
          Get-ChildItem "./plugin" -Recurse | Select-Object FullName

          # Artifact downloads as Guillotine.vst3/Contents/... - copy the whole bundle
          if (Test-Path "./plugin/Guillotine.vst3") {
            Write-Host "Found Guillotine.vst3 folder in artifact"
            Copy-Item -Recurse -Force "./plugin/Guillotine.vst3" "$destDir/"
          } else {
            Write-Host "Artifact contains raw Contents - wrapping in bundle folder"
            New-Item -ItemType Directory -Path "$destDir/Guillotine.vst3" -Force
            Copy-Item -Recurse -Force "./plugin/*" "$destDir/Guillotine.vst3/"
          }

          Write-Host "=== Installed plugin structure ==="
          Get-ChildItem "$destDir/Guillotine.vst3" -Recurse | Select-Object FullName

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Download pluginval
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/Tracktion/pluginval/releases/latest/download/pluginval_Windows.zip" -OutFile pluginval.zip
          Expand-Archive -Path pluginval.zip -DestinationPath C:\pluginval -Force
          Get-ChildItem C:\pluginval -Recurse

      - name: Verify plugin binary
        shell: pwsh
        run: |
          $bundlePath = "C:\Program Files\Common Files\VST3\Guillotine.vst3"
          $binaryPath = "$bundlePath\Contents\x86_64-win\Guillotine.vst3"

          Write-Host "=== Bundle structure ==="
          Get-ChildItem $bundlePath -Recurse | ForEach-Object {
            $size = if ($_.PSIsContainer) { "[DIR]" } else { "$([math]::Round($_.Length/1KB, 1)) KB" }
            Write-Host "$size  $($_.FullName)"
          }

          if (Test-Path $binaryPath) {
            Write-Host ""
            Write-Host "[OK] VST3 binary exists: $binaryPath"
            $info = Get-Item $binaryPath
            Write-Host "Size: $([math]::Round($info.Length/1MB, 2)) MB"
            Write-Host "Modified: $($info.LastWriteTime)"
          } else {
            Write-Error "VST3 binary not found at expected path: $binaryPath"
            exit 1
          }

      - name: Run pluginval
        shell: pwsh
        run: |
          $pluginval = Get-ChildItem C:\pluginval -Filter "pluginval.exe" -Recurse | Select-Object -First 1
          $vst3 = "C:\Program Files\Common Files\VST3\Guillotine.vst3"
          Write-Host "Running pluginval on: $vst3"
          & $pluginval.FullName --validate "$vst3" --strictness-level 5 --verbose

      - name: Build C++ unit tests
        run: |
          cd tests/unit
          cmake -B build -G "Visual Studio 17 2022" -A x64
          cmake --build build --config Release

      - name: Run all tests
        run: pytest tests/ -v

  check-release:
    needs: [build-windows, build-macos, build-linux, test-macos, test-windows]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if VERSION changed
        id: check
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "New version $VERSION detected, will create release"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

  release:
    needs: [check-release]
    runs-on: ubuntu-latest
    if: needs.check-release.outputs.should_release == 'true'

    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: Guillotine-VST3-Windows-x64
          path: ./windows-vst3/

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: Guillotine-macOS
          path: ./macos-artifacts/

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: Guillotine-VST3-Linux-x64
          path: ./linux-artifacts/

      - name: Create release archives
        run: |
          cd windows-vst3 && zip -r ../Guillotine-VST3-Windows-x64.zip . && cd ..
          cd macos-artifacts && zip -r ../Guillotine-macOS.zip . && cd ..
          cd linux-artifacts && zip -r ../Guillotine-VST3-Linux-x64.zip . && cd ..

      - name: Generate release notes
        run: |
          VERSION="${{ needs.check-release.outputs.version }}"
          echo "## Guillotine v$VERSION" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Installation" >> release_notes.md
          echo "- **Windows**: Extract and place \`Guillotine.vst3\` folder in your VST3 directory" >> release_notes.md
          echo "- **macOS**: Extract and copy VST3/AU to \`~/Library/Audio/Plug-Ins/\`" >> release_notes.md
          echo "- **Linux**: Extract to \`~/.vst3/\` or your DAW's VST3 directory" >> release_notes.md

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-release.outputs.version }}
          name: Guillotine v${{ needs.check-release.outputs.version }}
          body_path: release_notes.md
          files: |
            Guillotine-VST3-Windows-x64.zip
            Guillotine-macOS.zip
            Guillotine-VST3-Linux-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
