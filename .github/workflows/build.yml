name: Build Guillotine

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3

      - name: Sync VERSION to jucer
        shell: pwsh
        run: |
          $version = (Get-Content VERSION).Trim()
          (Get-Content Guillotine.jucer) -replace 'version="[^"]*"', "version=`"$version`"" | Set-Content Guillotine.jucer

      - name: Generate Windows project with Projucer
        shell: cmd
        run: |
          third_party\JUCE\extras\Projucer\Builds\VisualStudio2022\x64\Release\App\Projucer.exe --resave Guillotine.jucer --fix-missing-dependencies || (
            echo "Building Projucer first..."
            msbuild "third_party\JUCE\extras\Projucer\Builds\VisualStudio2022\Projucer.sln" /p:Configuration=Release /p:Platform=x64 /m
            third_party\JUCE\extras\Projucer\Builds\VisualStudio2022\x64\Release\App\Projucer.exe --resave Guillotine.jucer --fix-missing-dependencies
          )

      - name: Build SharedCode
        shell: cmd
        run: msbuild "Builds/VisualStudio2022/Guillotine_SharedCode.vcxproj" /p:Configuration=Release /p:Platform=x64 /m

      - name: Build VST3
        shell: cmd
        run: msbuild "Builds/VisualStudio2022/Guillotine_VST3.vcxproj" /p:Configuration=Release /p:Platform=x64 /m

      - name: Verify VST3 bundle structure
        shell: cmd
        run: |
          echo === Checking VST3 output structure ===
          dir /s "Builds\VisualStudio2022\x64\Release\VST3\"

          echo.
          echo === Verifying VST3 bundle ===
          if exist "Builds\VisualStudio2022\x64\Release\VST3\Guillotine.vst3\Contents\x86_64-win\Guillotine.vst3" (
            echo [OK] VST3 bundle structure is correct
            dir "Builds\VisualStudio2022\x64\Release\VST3\Guillotine.vst3\Contents\x86_64-win\Guillotine.vst3"
          ) else if exist "Builds\VisualStudio2022\x64\Release\VST3\Guillotine.vst3" (
            echo [OK] VST3 bundle folder exists
            dir "Builds\VisualStudio2022\x64\Release\VST3\Guillotine.vst3"
          ) else (
            echo [ERROR] VST3 bundle not found!
            exit /b 1
          )

      - name: Check embedded resources
        shell: pwsh
        run: |
          $vst3Path = "Builds/VisualStudio2022/x64/Release/VST3/Guillotine.vst3"
          $binary = Get-ChildItem -Path $vst3Path -Recurse -Include "*.vst3","*.dll" -File | Select-Object -First 1

          if (-not $binary) {
            Write-Host "[ERROR] No binary found in VST3 bundle"
            exit 1
          }

          Write-Host "Binary: $($binary.FullName)"
          $sizeMB = [math]::Round($binary.Length / 1MB, 2)
          Write-Host "Size: $sizeMB MB"

          # Binary should be > 1MB if resources are embedded
          if ($binary.Length -lt 1MB) {
            Write-Host "[ERROR] Binary too small ($sizeMB MB) - resources likely missing"
            exit 1
          }
          Write-Host "[OK] Binary size indicates resources are embedded"

      - name: Upload Windows VST3 artifact
        uses: actions/upload-artifact@v4
        with:
          name: Guillotine-VST3-Windows-x64
          path: Builds/VisualStudio2022/x64/Release/VST3/Guillotine.vst3
          retention-days: 30

  build-macos:
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Use latest Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Sync VERSION to jucer
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          sed -i '' "s/version=\"[^\"]*\"/version=\"$VERSION\"/" Guillotine.jucer

      - name: Build Projucer
        run: |
          xcodebuild -project "third_party/JUCE/extras/Projucer/Builds/MacOSX/Projucer.xcodeproj" \
            -scheme "Projucer - App" \
            -configuration Release \
            build

      - name: Generate Xcode project
        run: |
          "third_party/JUCE/extras/Projucer/Builds/MacOSX/build/Release/Projucer.app/Contents/MacOS/Projucer" --resave "Guillotine.jucer" --fix-missing-dependencies

      - name: Build VST3 with xcodebuild
        run: |
          xcodebuild \
            -project "Builds/MacOSX/Guillotine.xcodeproj" \
            -scheme "Guillotine - VST3" \
            -configuration Release \
            -destination "generic/platform=macOS" \
            ARCHS="arm64 x86_64" \
            ONLY_ACTIVE_ARCH=NO \
            MACOSX_DEPLOYMENT_TARGET=10.15 \
            build

      - name: Build AU with xcodebuild
        run: |
          xcodebuild \
            -project "Builds/MacOSX/Guillotine.xcodeproj" \
            -scheme "Guillotine - AU" \
            -configuration Release \
            -destination "generic/platform=macOS" \
            ARCHS="arm64 x86_64" \
            ONLY_ACTIVE_ARCH=NO \
            MACOSX_DEPLOYMENT_TARGET=10.15 \
            build

      - name: Verify macOS builds
        run: |
          echo "=== Verifying VST3 bundle ==="
          VST3_PATH="Builds/MacOSX/build/Release/Guillotine.vst3"
          if [ ! -d "$VST3_PATH" ]; then
            echo "[ERROR] VST3 not found"
            exit 1
          fi
          echo "[OK] VST3 bundle exists"

          BINARY="$VST3_PATH/Contents/MacOS/Guillotine"
          if [ ! -f "$BINARY" ]; then
            echo "[ERROR] VST3 binary not found"
            exit 1
          fi

          lipo -info "$BINARY"
          SIZE=$(stat -f%z "$BINARY")
          SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
          echo "Size: ${SIZE_MB} MB"

          if [ "$SIZE" -lt 1048576 ]; then
            echo "[ERROR] Binary too small (${SIZE_MB} MB) - resources likely missing"
            exit 1
          fi
          echo "[OK] Binary size indicates resources are embedded"

          echo "=== Verifying AU bundle ==="
          AU_PATH="Builds/MacOSX/build/Release/Guillotine.component"
          if [ ! -d "$AU_PATH" ]; then
            echo "[ERROR] AU not found"
            exit 1
          fi
          echo "[OK] AU bundle exists"
          lipo -info "$AU_PATH/Contents/MacOS/Guillotine"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Guillotine-macOS
          path: |
            Builds/MacOSX/build/Release/Guillotine.vst3
            Builds/MacOSX/build/Release/Guillotine.component
          retention-days: 30

  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libasound2-dev \
            libcurl4-openssl-dev \
            libfreetype6-dev \
            libgl1-mesa-dev \
            libjack-jackd2-dev \
            libwebkit2gtk-4.0-dev \
            libx11-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxss-dev \
            pkg-config

      - name: Sync VERSION to jucer
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          sed -i "s/version=\"[^\"]*\"/version=\"$VERSION\"/" Guillotine.jucer

      - name: Build Projucer
        run: |
          cd third_party/JUCE/extras/Projucer/Builds/LinuxMakefile
          make CONFIG=Release -j$(nproc)

      - name: Generate Linux project
        run: |
          third_party/JUCE/extras/Projucer/Builds/LinuxMakefile/build/Projucer --resave Guillotine.jucer --fix-missing-dependencies

      - name: Build with Make
        run: |
          cd Builds/LinuxMakefile
          make clean
          make -j$(nproc) CONFIG=Release

      - name: Verify Linux VST3 bundle
        run: |
          echo "=== Checking VST3 bundle structure ==="
          VST3_PATH="Builds/LinuxMakefile/build/Guillotine.vst3"
          if [ ! -d "$VST3_PATH" ]; then
            echo "[ERROR] VST3 bundle not found"
            exit 1
          fi
          echo "[OK] VST3 bundle directory exists"
          find "$VST3_PATH" -type f

          SO_FILE="$VST3_PATH/Contents/x86_64-linux/Guillotine.so"
          if [ ! -f "$SO_FILE" ]; then
            echo "[ERROR] VST3 .so file not found in bundle"
            exit 1
          fi
          echo "[OK] VST3 .so file found"
          ls -la "$SO_FILE"
          file "$SO_FILE"

          SIZE=$(stat -c%s "$SO_FILE")
          SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
          echo "Size: ${SIZE_MB} MB"

          if [ "$SIZE" -lt 1048576 ]; then
            echo "[ERROR] Binary too small (${SIZE_MB} MB) - resources likely missing"
            exit 1
          fi
          echo "[OK] Binary size indicates resources are embedded"

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Guillotine-VST3-Linux-x64
          path: Builds/LinuxMakefile/build/Guillotine.vst3
          retention-days: 30

  test:
    needs: [build-macos]
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: Guillotine-macOS
          path: ./plugin/

      - name: Install plugin to expected location
        run: |
          mkdir -p ~/Library/Audio/Plug-Ins/VST3
          cp -R ./plugin/Guillotine.vst3 ~/Library/Audio/Plug-Ins/VST3/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Download pluginval
        run: |
          curl -L -o pluginval.zip https://github.com/Tracktion/pluginval/releases/latest/download/pluginval_macOS.zip
          unzip pluginval.zip -d /usr/local/bin
          chmod +x /usr/local/bin/pluginval.app/Contents/MacOS/pluginval
          ln -s /usr/local/bin/pluginval.app/Contents/MacOS/pluginval /usr/local/bin/pluginval

      - name: Build C++ unit tests
        run: |
          cd tests/unit
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      - name: Run all tests
        run: pytest tests/ -v

  check-release:
    needs: [build-windows, build-macos, build-linux, test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if VERSION changed
        id: check
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Check if tag already exists
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "New version $VERSION detected, will create release"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

  release:
    needs: [check-release]
    runs-on: ubuntu-latest
    if: needs.check-release.outputs.should_release == 'true'

    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: Guillotine-VST3-Windows-x64
          path: ./windows-vst3/

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: Guillotine-macOS
          path: ./macos-artifacts/

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: Guillotine-VST3-Linux-x64
          path: ./linux-artifacts/

      - name: Create release archives
        run: |
          cd windows-vst3 && zip -r ../Guillotine-VST3-Windows-x64.zip . && cd ..
          cd macos-artifacts && zip -r ../Guillotine-macOS.zip . && cd ..
          cd linux-artifacts && zip -r ../Guillotine-VST3-Linux-x64.zip . && cd ..

      - name: Generate release notes
        run: |
          VERSION="${{ needs.check-release.outputs.version }}"
          echo "## Guillotine v$VERSION" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Installation" >> release_notes.md
          echo "- **Windows**: Extract and place \`Guillotine.vst3\` folder in your VST3 directory" >> release_notes.md
          echo "- **macOS**: Extract and copy VST3/AU to \`~/Library/Audio/Plug-Ins/\`" >> release_notes.md
          echo "- **Linux**: Extract to \`~/.vst3/\` or your DAW's VST3 directory" >> release_notes.md

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-release.outputs.version }}
          name: Guillotine v${{ needs.check-release.outputs.version }}
          body_path: release_notes.md
          files: |
            Guillotine-VST3-Windows-x64.zip
            Guillotine-macOS.zip
            Guillotine-VST3-Linux-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
